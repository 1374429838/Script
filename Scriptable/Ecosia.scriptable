// Scriptable使用的变量;
// Ecosia是一个总部位于德国柏林的搜索引擎，它们将至少80%的利润捐赠给非营利组织，用于种植树木。该组件用于显示账户植树;
// 可搭配快捷搜索脚本设置为默认搜索引擎体验更佳 https://raw.githubusercontent.com/githubdulong/Script/master/Surge/Q-Search_All_in_one.sgmodule;

// 1.1.4版本 "修改汉化自 https://www.scriptables.net";

// 第一步：先登陆 https://www.ecosia.org 再通过Safari共享菜单使用快捷方式获取令牌：https://www.icloud.com/shortcuts/8e3d009ee2a94c2d99d3cdb02f3e16d9;

// 第二步：将获取到的令牌填入 Scriptable > Parameter;

let widgetInputRAW = args.widgetParameter;
let token;
if (widgetInputRAW !== null) {
  token = widgetInputRAW.toString().trim();
  if (/^[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$/.test(token) === false) {	  
    throw new Errpr('令牌格式无效')
  }
} else {
  throw new Error('没有通过小部件参数设置令牌！您可以在此处请求令牌：https://www.ecosia.org/account/login')
}
////////////////////////////////////////////////////////////////////////////////
let backColor; //小组件渐变上背景颜色
let backColor2; //小组件渐变下背景颜色
let textColor; //小组件文文字颜色

if (Device.isUsingDarkAppearance()) {
  backColor = '111111';
  backColor2 = '222222';
  textColor = 'EDEDED'; //if 暗黑模式
} else {
  backColor = '229954';
  backColor2 = '52be80';
  textColor = 'EDEDED'; //else 明亮模式
}
////////////////////////////////////////////////////////////////////////////////
async function getTreeCounter(token) {
  try {
    const url = "https://api.ecosia.org/v1/accounts/v2/personal_counter?token=" + token
    let req = new Request(url)
    let res = await req.loadJSON()
    return parseInt(res.personal_counter)
  } catch (error) {
    throw new Error('An error occurred when loading data from the Ecosia API. Please check the entered token.')
  }
}

async function getLogo() {
  let fm = FileManager.local()
  const pathLogo = fm.joinPath(fm.temporaryDirectory(), 'ecosiaLogo')

  if (fm.fileExists(pathLogo)) {
    return fm.readImage(pathLogo)
  } else {
    try {
      let req = new Request('https://raw.githubusercontent.com/ThisIsBenny/iOS-Widgets/main/Ecosia/logo.png') //logo
      let logo = await req.loadImage()
      fm.writeImage(pathLogo, logo)
      return logo
    } catch (e) {
      console.error(e)
      return null
    }
  }
}
console.log('Load Tree Counter')
let treeCounter = await getTreeCounter(token);
console.log('Tree Counter loaded')
console.log(treeCounter)
console.log('Load Logo')
let ecosiaLogo = await getLogo()
console.log('Logo loaded')
// Create Widget
let widget = new ListWidget();

const gradient = new LinearGradient()
gradient.locations = [0, 1]
gradient.colors = [
  new Color(backColor),
  new Color(backColor2)
]
widget.backgroundGradient = gradient

widget.url = 'https://ecosia.org/'

widget.setPadding(10, 10, 10, 10)

if (ecosiaLogo !== null) {
  let titleLogo = widget.addImage(ecosiaLogo)
  titleLogo.imageSize = new Size(50, 50)
  titleLogo.rightAlignImage()
  if (config.widgetFamily === 'large') {
    widget.addSpacer()
  } else {
    widget.addSpacer(5)
  }
} else {
  let title = widget.addText("Ecosia")
  title.font = Font.mediumSystemFont(12)
  title.textColor = new Color(textColor)
  widget.addSpacer()
}

let counterText = widget.addText(`${treeCounter.toLocaleString(Device.locale().replace('_', '-'))} 🌲`) //🌳🌴
counterText.font = Font.regularSystemFont(36)
counterText.minimumScaleFactor = 0.7;
counterText.lineLimit = 1
counterText.centerAlignText()
counterText.textColor = new Color(textColor)

widget.addSpacer()

if (!config.runsInWidget) {
  await widget.presentSmall()
} else {
//   Tell the system to show the widget.
  Script.setWidget(widget)
  Script.complete()
}
